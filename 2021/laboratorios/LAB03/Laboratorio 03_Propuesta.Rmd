---
title: 'Laboratorio 03: Detección de valores atípicos'
author: "Santiago Banchero, Juan Fernandez, Eloisa Piccoli"
date: "02/03/2021"
output:
  html_document: default
  pdf_document: default
---

## Sobre los datos

**1.a) Explore y explique qué características posee el dataset MPI_national.csv.**
<br />
<br />


```{r}
data = read.csv('https://raw.githubusercontent.com/dm-uba/dm-uba.github.io/master/2021/laboratorios/LAB03/MPI_national.csv', sep = ",",header = TRUE)

```

Observamos la estructura del dataset y las características de las variables numéricas:

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)

# Structura de variables no numéricas
# Para usar nagate y %>% usar librería tidyverse
data %>% select_if(negate(is.numeric)) %>% str(data)


# Veamos el rango de las variables numéricas
# Kable del paquete knitr sirve para mostrar en formato tabla
kable(data%>% select_if(is.numeric) %>% summarise_each(funs(range)))

# Cantidad de paises
length(unique(data$Country))

```

<br />
Se cuenta con tres tipos de mediciones recolectadas para zonas urbanas y rurales en 102 países en desarrollo. 
Existe un solo registro por país (largo de dataset coincide con cantidad de paises). Se desconoce la fecha del relevamiento de los datos.
<br />

**1.b) Cuál es la distribución de las variables:**

```{r}
# Calculamos el desvío standard y comparamos las zonas para cada medida
sd <- apply(data[,c(3:8)],2, sd)
sd[order(names(sd))]

```
<br/>
Las zonas rurales presentan mayor dispersión comparadas con la misma métrica en zonas urbanas.
<br/>
```{r}
# Para visualizaciones usaremos ggplot2
library(ggplot2)

# Instalamos una librería que permite visualizar
# varios charts en una ventana
# https://github.com/thomasp85/patchwork

# devtools::install_github("thomasp85/patchwork")
library(patchwork)


# Generamos los histogramas para zonas urbanas
tamaño_texto = 7
cant_bins = 30

u1 <- qplot(data$MPI.Urban, geom="histogram", main = "Hist MPI.Urban",  
            xlab = "MPI.Urban", ylab = "Frecuencia", binwidth=diff(range(data$MPI.Urban))/cant_bins) + theme(text = element_text(size = tamaño_texto))

u2 <- qplot(data$Headcount.Ratio.Urban, main = "Hist HC Ratio Urban", geom="histogram", xlab = "Headcount Ratio Urban", ylab = "Frecuencia", binwidth=diff(range(data$Headcount.Ratio.Urban))/cant_bins) + theme(text = element_text(size = tamaño_texto))

u3 <- qplot(data$Intensity.of.Deprivation.Urban, main = "Hist. Intensity of Depr. Urban", geom="histogram",  xlab = "Intensity of Depr. Urban", ylab = "Frecuencia",binwidth=diff(range(data$Intensity.of.Deprivation.Urban))/cant_bins) + theme(text = element_text(size = tamaño_texto))

# Y los mismos para zonas Rurales
r1 <- qplot(data$MPI.Rural, geom="histogram", main = "Hist MPI Rural",  
            xlab = "MPI.Rural", ylab = "Frecuencia", binwidth=diff(range(data$MPI.Rural))/cant_bins) + theme(text = element_text(size = tamaño_texto))

r2 <- qplot(data$Headcount.Ratio.Rural, main = "Hist HC Ratio Rural", geom="histogram", xlab = "Headcount Ratio Rural", ylab = "Frecuencia", binwidth=diff(range(data$Headcount.Ratio.Rural))/cant_bins) + theme(text = element_text(size = tamaño_texto))

r3 <- qplot(data$Intensity.of.Deprivation.Rural, main = "Hist. Int. of Depr. Rural", geom="histogram",  xlab = "Intensity of Depr. Rural", ylab = "Frecuencia",binwidth=diff(range(data$Intensity.of.Deprivation.Rural))/cant_bins) + theme(text = element_text(size = tamaño_texto))


# Y los graficamos en paralelo para facilitar la comparacion
(u1 | u2 | u3) /
  (r1 | r2 | r3)
```
<br/>
Las zonas urbanas presentan una asimetría a derecha más marcada que las zonas rurales para MPI y Ratio de pobreza per capita, mientras que la distribución de Intensidad de Privaciones para ambas zonas se asemeja.
<br />
<br />

## Tratamiento de outliers

<br/>
**2.a) ¿Existen atributos que poseen valores atípicos? **
<br/>
<br/>
Normalizamos de variables con z-score para que sean comparables. Este método también nos informa sobre a cuántos desvíos de la media se distribuyen los datos.
<br/>
```{r}

for(i in 3:ncol(data)) {
data[,i] <- (data[,i]-mean(data[,i]))/(sd(data[,i]))}

# Configuramos el tamaño del lienzo (ver "par" del paquete graphics)
par(mfrow=c(1, 1), mar=c(5, 12, 4, 2) ) 

# Y graficamos un solo boxplot con todas las medidas
boxplot(data[,c(3:8)],horizontal = TRUE, las=1, xlab="z-score")
stripchart(data[,c(3:8)], vertical = FALSE ,
    method = "jitter", add = TRUE, pch = 20, col = 'blue')

```

```{r, fig.show='hide'}
# Que paises son outliers segun boxplot de MPI Urban
MPI.Urban_Umbral = boxplot(data[,c(3)])$stats[5]
data["Country"][data$MPI.Urban > MPI.Urban_Umbral,]
# Que paises son outliers segun boxplot de Headcount Ratio Urban
HC.Ratio.Urban_umbral = boxplot(data[,c(4)])$stats[5]
data["Country"][data$Headcount.Ratio.Urban > HC.Ratio.Urban_umbral,]

```

Según el boxplot para MPI Urban **Chad y South Sudan** son países atípicos, mientras que si observamos el ratio de pobreza per capita para zonas urbanas (HC Ratio Urban), el país considerado outlier es **South Sudan**. 



<br/>
**2.b) Seleccione una variable con outliers y analice utilizando los métodos univariados IRQ, SD, y Z-score**
<br/>
```{r}
### Focalicemos el análisis en MPI Urban ###

# Rango intercuartil
Q1 = as.numeric(quantile(data$MPI.Urban)["25%"])
Q3 = as.numeric(quantile(data$MPI.Urban))[4]

IQR = Q3 - Q1

lim_sup = Q3 + 1.5*IQR
lim_inf = Q1 - 1.5*IQR

# Veamos de qué pais estamos hablando
sort(data$Country[data$MPI.Urban > lim_sup]) 
```
<br/>
**2.c) Observe qué ocurre con la distribución de la feature elegida en caso de eliminar los outliers. Grafique un boxplot de con la nueva distribución. Concluya al respecto**
<br />

```{r}

# Observemos la distribución de MPI Urban sin outliers
MPI.Urban_nuevo_bp = boxplot(data[c(3)][data[c(3)] <= MPI.Urban_Umbral],main="MPI Urban sin outliers", ylab="z-score", xlab="MPI Urban acotada") 

# Luego de eliminar los outliers, el nuevo valor atipico es:
MPI.Urban_nuevo_bp$out

# Los paises considerados outliers con Boxplot son los 
# mismos que con IQR

data["Country"][data[, "MPI.Urban"] == MPI.Urban_nuevo_bp$out,]

```
<br />
Dada la asimetría de la distribución, luego de eliminar outliers, Somalía es ahora clasificado como atípico. 
<br />
<br/>

**2.c) Extienda el análisis a 3 variables y analice si existen valores atípicos utilizando algún método multivariado.**
<br />

```{r , message=FALSE, warning=FALSE}

# Distancia Mahalanobis para zonas urbanas
vector_medias = colMeans(data[,c(3:5)]) 
matriz_var_cov = cov(data[,c(3:5)])

# Creamos una variable con la distancia
data$maha = sqrt(mahalanobis(data[,c(3:5)],vector_medias,matriz_var_cov))

# Los 3 registros mas distantes
top_maha <- head(data[order(data$maha,decreasing = TRUE),],3)
print(top_maha$Country)
```
<br/>
**Bonus track:** ¿Qué países son considerados outliers según LOF?
<br/>
```{r, message=FALSE, warning=FALSE}

library(Rlof)
library(scatterplot3d)

data$LOF_score<-lof(data[,c(3:5)], k=5) 
top_LOF <- head(data[order(data$LOF_score,decreasing = TRUE),],3) 
print(top_LOF$Country)

```
<br/>
Veamos donde se ubican los puntos
<br/>
```{r}

scatterplot3d(data[,3], data[,4],data[,5], 
color=ifelse(data$LOF_score>=min(top_LOF$LOF_score),"red","black"), xlab="z-score MPI Urban",ylab="z-score HC Ratio Urban",zlab="z-score Intensity of Deprivation Urban")

```

